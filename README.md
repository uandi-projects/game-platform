# Convex Auth Email Invite System

A complete Next.js + Convex authentication system with email-based invites and role-based access control. This project provides a secure, admin-managed authentication system where users can only join through invitations.

## Features

- **No Public Sign-up**: Users cannot create accounts directly - they must be invited
- **Role-Based Access Control**: Admin and User roles with hierarchical permissions
- **Email Invitations**: Secure invite system using Resend with time-limited tokens
- **Password Reset**: Secure password reset functionality
- **Bootstrap Admin**: CLI tool to create the first admin user
- **Interactive CLI Tools**: Create users and send invites via command line

## Tech Stack

- **Backend**: [Convex](https://convex.dev/) - Database and server functions
- **Frontend**: [Next.js 15](https://nextjs.org/) with App Router
- **Authentication**: [Convex Auth](https://labs.convex.dev/auth) with Password provider
- **Email**: [Resend](https://resend.com) for transactional emails
- **Styling**: [Tailwind CSS](https://tailwindcss.com/)
- **UI**: React 19 with TypeScript

## Quick Start

1. **Clone and install dependencies**:
   ```bash
   git clone <this-repo>
   cd convex-auth-practice
   npm install
   ```

2. **Set up Convex**:
   ```bash
   npx convex dev
   ```

3. **Configure environment variables** (see Setup section below)

4. **Create your first admin user**:
   ```bash
   npm run bootstrap-admin
   ```

5. **Start the development server**:
   ```bash
   npm run dev
   ```

## Email Invite Authentication System with Role-Based Access Control

This project implements a comprehensive authentication system using Convex Auth and Resend with role-based access control (RBAC). Here's how it works:

### Architecture Overview

- **No public sign-up**: Users cannot create accounts directly
- **Role-based access**: Two roles - Admin and User with hierarchical permissions
- **Admin-only invites**: Only authenticated admins can invite new users
- **Email-based invites**: Invitations are sent via Resend with secure tokens
- **Password creation**: Invited users create their password on first access
- **Token security**: One-time use tokens with 7-day expiration
- **Password reset**: Secure password reset functionality with 1-hour expiry tokens

## Complete Setup Guide

### 1. Convex Setup

After cloning the repository, you'll need to set up your Convex backend:

```bash
# Install dependencies
npm install

# Initialize Convex (creates a new deployment)
npx convex dev
```

This will:
- Create a new Convex deployment
- Generate your `NEXT_PUBLIC_CONVEX_URL`
- Set up the database schema
- Start the Convex development server

### 2. Environment Variables

Create a `.env.local` file in the project root:

```bash
# Convex (automatically generated by `npx convex dev`)
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# Email configuration (required for invites)
RESEND_API_KEY=re_your_api_key_here
FROM_EMAIL=noreply@yourdomain.com
NEXT_PUBLIC_APP_DOMAIN=http://localhost:3000
```

**Set the same email variables in Convex:**

```bash
npx convex env set RESEND_API_KEY re_your_api_key_here
npx convex env set FROM_EMAIL noreply@yourdomain.com
npx convex env set NEXT_PUBLIC_APP_DOMAIN http://localhost:3000
npx convex env set SITE_URL http://localhost:3000
```

**⚠️ CRITICAL: JWT Authentication Setup**

For authentication to work properly, you must also set JWT keys in your Convex environment:

1. **Generate JWT keys** by running:
   ```bash
   node -e "
   import('jose').then(async ({ exportJWK, exportPKCS8, generateKeyPair }) => {
     const keys = await generateKeyPair('RS256', { extractable: true });
     const privateKey = await exportPKCS8(keys.privateKey);
     const publicKey = await exportJWK(keys.publicKey);
     const jwks = JSON.stringify({ keys: [{ use: 'sig', ...publicKey }] });
     console.log('JWT_PRIVATE_KEY=\"' + privateKey.trimEnd().replace(/\\n/g, ' ') + '\"');
     console.log('JWKS=' + jwks);
   });
   "
   ```

2. **Copy the output** and set these environment variables in your **Convex dashboard** (not in .env.local):
   - `JWT_PRIVATE_KEY` - The private key from step 1
   - `JWKS` - The JSON Web Key Set from step 1

3. **Alternative method** using the Convex CLI:
   ```bash
   npx convex env set JWT_PRIVATE_KEY  # Enter the private key when prompted
   npx convex env set JWKS            # Enter the JWKS when prompted
   ```

**Note**: These JWT keys are essential for token signing and verification. Without them, authentication will fail with "Could not verify OIDC token claim" errors.

**⚠️ Common JWT Key Formatting Issues:**

- **PKCS#8 Format Errors**: If you get `"pkcs8" must be PKCS#8 formatted string` errors, ensure the private key uses spaces instead of `\n` escape sequences
- **Line Break Issues**: Private keys must have line breaks replaced with single spaces (not `\n` or `\\n`)
- **Missing Key Pairs**: Both `JWT_PRIVATE_KEY` and `JWKS` must be set - missing either will cause authentication failures
- **Mismatched Keys**: The private key and JWKS must be from the same key pair generation - don't mix keys from different generations
- **Environment Variable Location**: JWT keys must be set in the **Convex dashboard**, not in your local `.env.local` file

**Correct JWT_PRIVATE_KEY format example:**
```
-----BEGIN PRIVATE KEY----- MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC... -----END PRIVATE KEY-----
```
*(Notice single spaces replacing line breaks)*

### 3. Resend Email Setup

1. Create a [Resend account](https://resend.com)
2. Add and verify your domain in the Resend dashboard
3. Create an API key with "Send emails" permission
4. Update the `RESEND_API_KEY` in your environment variables

**For development**: You can use Resend's test domain initially, but custom domains are recommended for production.

### 4. Create Your First Admin User

Use the interactive bootstrap script to create your first admin user:

```bash
npm run bootstrap-admin
```

This will:
- Check for existing users in your database
- Prompt you for admin user details (name and email)
- Create a secure invite token
- Display the invite URL for account creation

**Important**: The bootstrap script only works when no admin users exist, ensuring security.

### Role-Based Access Control

#### Roles and Permissions

- **User Role**: Basic access to application features
- **Admin Role**: Full access including user management and invitations
- **Hierarchical**: Admin role includes all User permissions plus additional privileges

### How It Works

#### 1. Admin Invite Flow (`/admin`)
*Requires Admin Role*

- Admin visits `/admin` page (access restricted to admins)
- Enters email address and selects role (User or Admin)
- System creates secure token with role information
- Sends email via Resend with invite link

#### 2. User Sign-Up Flow (`/invite`)

- User receives email with invite link: `/invite?email=...&token=...`
- User clicks link and creates password
- System validates token and assigns the specified role
- User account created with proper role assignment

#### 3. Password Reset Flow

- User clicks "Forgot your password?" on `/signin`
- Enters email on `/forgot-password` page
- If account exists, reset email sent (no email enumeration)
- User clicks reset link: `/reset-password?email=...&token=...`
- User creates new password (1-hour token expiry)

#### 4. Regular Sign-In (`/signin`)

- Existing users sign in with email/password
- No sign-up option available on this page
- Includes forgot password link

### Key Files

#### Backend (Convex)
- **`convex/auth.ts`**: Convex Auth configuration with Password provider
- **`convex/authorization.ts`**: Role-based access control helpers and utilities
- **`convex/invites.ts`**: Invite token management, email sending, and password reset
- **`convex/users.ts`**: User management functions and queries
- **`convex/schema.ts`**: Database schema with roles, inviteTokens, and passwordResetTokens

#### Frontend (Next.js)
- **`app/admin/page.tsx`**: Admin interface for sending invites (admin-only access)
- **`app/invite/page.tsx`**: User invite acceptance and password creation
- **`app/signin/page.tsx`**: Standard sign-in with forgot password link
- **`app/forgot-password/page.tsx`**: Password reset request page
- **`app/reset-password/page.tsx`**: New password creation page

#### Tools
- **`scripts/create-user.mjs`**: CLI tool for manual user creation
- **`scripts/create-admin-invite.mjs`**: Bootstrap script for creating the first admin user

### Database Schema

```typescript
// Users table with role-based access control
users: defineTable({
  name: v.optional(v.string()),
  image: v.optional(v.string()),
  email: v.optional(v.string()),
  emailVerificationTime: v.optional(v.number()),
  phone: v.optional(v.string()),
  phoneVerificationTime: v.optional(v.number()),
  isAnonymous: v.optional(v.boolean()),
  role: v.optional(v.union(v.literal("admin"), v.literal("user"))),
}).index("email", ["email"]),

// Invite tokens with role assignment
inviteTokens: defineTable({
  email: v.string(),
  token: v.string(),
  expiresAt: v.number(),
  createdBy: v.string(),
  used: v.boolean(),
  role: v.union(v.literal("admin"), v.literal("user")),
}).index("by_email_token", ["email", "token"]),

// Password reset tokens
passwordResetTokens: defineTable({
  email: v.string(),
  token: v.string(),
  expiresAt: v.number(),
  used: v.boolean(),
}).index("by_email_token", ["email", "token"]),
```

### Security Features

#### Authentication & Authorization
- **Role-based access control**: Hierarchical permission system
- **Server-side authorization**: All permissions validated in Convex backend
- **Admin-only operations**: Invite creation restricted to admin users
- **Protected routes**: Admin pages inaccessible to regular users

#### Token Security
- **Invite tokens**: 7-day expiration, one-time use
- **Password reset tokens**: 1-hour expiration for security
- **Secure generation**: Uses `crypto.randomUUID()` for all tokens
- **Token cleanup**: Removes old unused tokens automatically

#### Privacy & Security
- **No email enumeration**: Password reset doesn't reveal if account exists
- **Secure validation**: Server-side validation of all tokens
- **Auto-cleanup**: Expired tokens handled automatically

### Production Deployment

When deploying to production:

1. Update `NEXT_PUBLIC_APP_DOMAIN` to your production domain
2. Ensure Resend domain is verified for production
3. Set production environment variables in Convex dashboard

## CLI Tools

### Bootstrap Admin Creation

Create your first admin user when starting a new project:

```bash
npm run bootstrap-admin
```

**Interactive prompts**:
- Full name for the admin user
- Email address
- Confirmation to create the invite

**Features**:
- Only works when no admin users exist (security measure)
- Checks for existing users and prevents conflicts
- Creates secure invite tokens with 7-day expiration
- Displays invite URL for immediate account creation

### Manual User Creation

Create user profiles directly via CLI:

```bash
npm run create-user
```

**Interactive prompts**:
- Email address
- Name (optional, defaults to email prefix)
- Role (User or Admin)
- Password (for reference, but not used for authentication)

**Important**: This tool only creates user profiles, not authentication credentials. Users created this way must use the "Forgot Password" flow to set up their login credentials.

**Recommended**: Use the admin panel `/admin` to send proper invites instead, as it creates proper authentication credentials.

### API Reference

#### Authorization Helpers

```typescript
import { requireAdmin, hasRole, VALID_ROLES } from "./authorization";

// Require admin role
await requireAdmin(ctx);

// Check if user has specific role
const isAdmin = await hasRole(ctx, VALID_ROLES.ADMIN);

// Get current user with role info
const user = await getAuthenticatedUser(ctx);
```

### Customization

#### Email Templates

Edit email templates in `convex/invites.ts`:
- `sendInviteEmail` action for invitation emails
- `sendPasswordResetEmail` action for password reset emails

#### Token Expiration

Modify token expiration periods:

```typescript
// Invite tokens (7 days)
const expiresAt = Date.now() + 7 * 24 * 60 * 60 * 1000;

// Password reset tokens (1 hour)
const expiresAt = Date.now() + 60 * 60 * 1000;
```

#### Role System

Extend roles in `convex/authorization.ts`:

```typescript
export const VALID_ROLES = {
  USER: "user" as const,
  ADMIN: "admin" as const,
  // Add new roles here
} as const;

const roleHierarchy = {
  [VALID_ROLES.USER]: 0,
  [VALID_ROLES.ADMIN]: 1,
  // Update hierarchy
};
```

## Available Scripts

- **`npm run dev`**: Start development servers for both frontend and backend
- **`npm run dev:frontend`**: Start only the Next.js development server
- **`npm run dev:backend`**: Start only the Convex development server
- **`npm run build`**: Build the application for production
- **`npm run lint`**: Run ESLint for code quality checks
- **`npm run bootstrap-admin`**: Create the first admin user (interactive)
- **`npm run create-user`**: Create a user profile manually (interactive)

## Project Structure

```
convex-auth-practice/
├── app/                    # Next.js App Router pages
│   ├── admin/             # Admin-only interface
│   ├── invite/            # User invite acceptance
│   ├── signin/            # User authentication
│   ├── forgot-password/   # Password reset request
│   └── reset-password/    # New password creation
├── convex/                # Convex backend functions
│   ├── auth.ts           # Authentication configuration
│   ├── authorization.ts  # Role-based access control
│   ├── invites.ts        # Invite and email management
│   ├── users.ts          # User management functions
│   └── schema.ts         # Database schema definition
├── scripts/              # CLI utilities
│   ├── create-admin-invite.mjs  # Bootstrap admin creation
│   └── create-user.mjs          # Manual user creation
└── package.json         # Project dependencies and scripts
```

## Troubleshooting

### Common Issues

1. **"Could not find public function"** error:
   ```bash
   npx convex dev --once
   ```

2. **Bootstrap script fails with existing admin**:
   - The script prevents creating multiple admins for security
   - Delete existing admin users first, or use the regular invite flow

3. **Email not sending**:
   - Verify Resend API key is correct
   - Check that your domain is verified in Resend
   - Ensure `FROM_EMAIL` uses your verified domain

4. **Environment variables not loading**:
   - Restart your development server after adding `.env.local`
   - Verify Convex environment variables are set: `npx convex env list`

## Extending the System

### Adding New Roles

1. Update `VALID_ROLES` in `convex/authorization.ts`
2. Add role to the hierarchy in `roleHierarchy`
3. Update database schema in `convex/schema.ts`
4. Add role options to admin interface and CLI tools

### Custom Email Templates

Edit email templates in `convex/invites.ts`:
- `sendInviteEmail`: Customize invitation emails
- `sendPasswordResetEmail`: Customize password reset emails

### Additional Authentication Providers

To add other authentication methods (Google, GitHub, etc.), see the [Convex Auth Configuration docs](https://labs.convex.dev/auth/config).

## Learn More

- [Convex Documentation](https://docs.convex.dev/) - Learn about Convex features
- [Convex Auth Guide](https://labs.convex.dev/auth) - Authentication system documentation
- [Next.js Documentation](https://nextjs.org/docs) - Learn about Next.js features
- [Resend Documentation](https://resend.com/docs) - Email API documentation

## Community

Join the Convex community:

- [Convex Discord](https://convex.dev/community) - Get help and discuss with other developers
- [Convex GitHub](https://github.com/get-convex/) - Star and contribute to open-source projects
